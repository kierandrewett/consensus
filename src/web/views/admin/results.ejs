<%- include('../partials/header') %>
<%- include('../partials/election-type-helper') %>

<div class="admin-dashboard">
    <%- include('../partials/admin-sidebar', { activePage: 'results' }) %>
    
    <div class="admin-content">
        <div class="admin-header">
            <div class="admin-header-info">
                <h1>Election Results</h1>
                <p>View and analyse election outcomes</p>
            </div>
        </div>
        
        <% 
            const closedElections = elections.filter(e => e.status === 'CLOSED');
            const activeElections = elections.filter(e => e.status === 'ACTIVE');
            const draftElections = elections.filter(e => e.status === 'DRAFT');
        %>
        
        <% if (elections.length === 0) { %>
            <div class="admin-section">
                <div class="empty-state">
                    <i data-lucide="bar-chart-2" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                    <h3>No Elections</h3>
                    <p>Create an election to start tracking results.</p>
                    <a href="/admin/elections/new" class="btn btn-primary" style="margin-top: 1rem;">
                        <i data-lucide="plus"></i>
                        Create Election
                    </a>
                </div>
            </div>
        <% } else { %>
            
            <div class="results-filters">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">All <span class="filter-count"><%= elections.length %></span></button>
                    <button class="filter-tab" data-filter="closed">Completed <span class="filter-count"><%= closedElections.length %></span></button>
                    <button class="filter-tab" data-filter="active">Active <span class="filter-count"><%= activeElections.length %></span></button>
                    <button class="filter-tab" data-filter="draft">Draft <span class="filter-count"><%= draftElections.length %></span></button>
                </div>
                <div class="filter-search">
                    <i data-lucide="search"></i>
                    <input type="text" id="searchResults" placeholder="Search elections...">
                </div>
            </div>
            
            <div class="results-grid" id="resultsGrid">
                <% elections.forEach(election => { %>
                    <div class="result-card" data-status="<%= election.status.toLowerCase() %>" data-name="<%= election.name.toLowerCase() %>"<% if (election.status === 'ACTIVE') { %> data-end-date="<%= election.endDate %>"<% } %>>
                        <div class="result-card-header">
                            <div>
                                <h3><a href="/admin/elections/<%= election.electionID %>"><%= election.name %></a></h3>
                                <span class="result-meta"><%- formatElectionType(election.electionType) %> Â· <%= election.voteCount %> votes</span>
                            </div>
                            <% if (election.status === 'CLOSED') { %>
                                <% if (election.resolutionType === 'RECALL') { %>
                                    <span class="result-status result-status-recall">Recalled</span>
                                <% } else if (election.hasTie) { %>
                                    <span class="result-status result-status-tie">Tie</span>
                                <% } else if (election.winner) { %>
                                    <span class="result-status result-status-resolved">Resolved</span>
                                <% } %>
                            <% } else if (election.status === 'ACTIVE') { %>
                                <span class="result-status result-status-active"><span class="pulse-dot"></span> Live</span>
                            <% } else { %>
                                <span class="result-status result-status-draft">Draft</span>
                            <% } %>
                        </div>
                        
                        <% if (election.status === 'CLOSED') { %>
                            <% if (election.resolutionType === 'RECALL') { %>
                                <div class="result-recall-notice">
                                    <strong>Election recalled</strong>
                                    <p>This election was voided due to a tie.</p>
                                </div>
                            <% } else if (election.winner) { %>
                                <div class="result-winner">
                                    <div class="winner-info">
                                        <span class="winner-name"><%= election.winner.candidateName %></span>
                                        <span class="winner-votes"><%= election.winner.votes %> votes (<%= election.winner.percentage.toFixed(1) %>%)</span>
                                        <% if (election.resolutionType === 'RANDOM') { %>
                                            <span class="resolution-badge">Random tiebreak</span>
                                        <% } else if (election.resolutionType === 'MANUAL') { %>
                                            <span class="resolution-badge">Manual selection</span>
                                        <% } %>
                                    </div>
                                </div>
                            <% } else if (election.hasTie) { %>
                                <div class="result-tie-warning">
                                    <strong>Tie requires resolution</strong>
                                    <p>Multiple candidates have equal votes.</p>
                                </div>
                            <% } %>
                        <% } else if (election.status === 'ACTIVE') { %>
                            <p class="result-end-date">Ends <%= new Date(election.endDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></p>
                            <p class="result-countdown" data-end="<%= election.endDate %>">Calculating...</p>
                        <% } else { %>
                            <p class="result-draft-note">Not started yet.</p>
                        <% } %>
                        
                        <div class="result-footer">
                            <% if (election.status === 'CLOSED') { %>
                                <a href="/elections/<%= election.electionID %>" class="btn btn-primary btn-sm">View Results</a>
                            <% } else if (election.status === 'ACTIVE') { %>
                                <a href="/admin/elections/<%= election.electionID %>" class="btn btn-primary btn-sm">Monitor</a>
                            <% } else { %>
                                <a href="/admin/elections/<%= election.electionID %>" class="btn btn-secondary btn-sm">Edit</a>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            </div>
            
            <div class="no-results-message" id="noResultsMessage" style="display: none;">
                <i data-lucide="search-x" style="width: 32px; height: 32px;"></i>
                <p>No elections match your filter.</p>
            </div>
            
        <% } %>
    </div>
</div>

<script src="/public/js/countdown.js"></script>
<script src="/public/js/admin-results.js"></script>

<%- include('../partials/footer') %>
