<%- include('../partials/header') %>
<%- include('../partials/election-type-helper') %>

<div class="admin-dashboard">
    <%- include('../partials/admin-sidebar', { activePage: 'elections' }) %>
    
    <div class="admin-content">
        <div class="admin-header">
            <div class="admin-header-info" style="display: flex; flex-direction: row; align-items: center; gap: 1rem;">
                <a href="/admin/elections" style="text-decoration: none; color: var(--secondary-color);">
                    <i data-lucide="arrow-left" style="width: 24px; height: 24px;"></i>
                </a>
                <div>
                    <h1><%= election.name %></h1>
                    <p><%= election.description %></p>
                </div>
            </div>
        </div>
        
        <div class="admin-stats" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-card">
                <div class="stat-icon">
                    <i data-lucide="calendar" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="stat-info">
                    <h3><%- formatElectionType(election.electionType) %></h3>
                    <p>Election Type</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i data-lucide="<%= election.status === 'ACTIVE' ? 'check-circle' : election.status === 'CLOSED' ? 'lock' : 'clock' %>" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="stat-info">
                    <h3><%= election.status %></h3>
                    <p>Status</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i data-lucide="file-check" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="stat-info">
                    <h3><%= voteCount %></h3>
                    <p>Votes Cast</p>
                </div>
            </div>
        </div>
        
        <div class="admin-section">
            <h2>Election Timeline</h2>
            <div style="padding: 1rem 0;">
                <p><strong>Start Date:</strong> <%= new Date(election.startDate).toLocaleString() %></p>
                <p><strong>End Date:</strong> <%= new Date(election.endDate).toLocaleString() %></p>
            </div>
            
            <% if (election.status === 'ACTIVE' && new Date(election.startDate) > new Date()) { %>
            <div class="alert alert-info" id="countdownAlert" style="display: flex; align-items: center; gap: 0.75rem; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                <i data-lucide="clock" style="width: 24px; height: 24px; color: #1d4ed8;"></i>
                <div style="color: #1e40af;">
                    <strong>Election Scheduled</strong>
                    <p style="margin: 0.25rem 0 0;">Voting will open to public voting in <span id="countdown" style="font-weight: 700; font-family: monospace; font-size: 1.1em;">--:--:--</span></p>
                </div>
            </div>
            <script>
                (function() {
                    const startTime = new Date('<%= new Date(election.startDate).toISOString() %>').getTime();
                    const countdownEl = document.getElementById('countdown');
                    
                    function updateCountdown() {
                        const now = Date.now();
                        const diff = startTime - now;
                        
                        if (diff <= 0) {
                            countdownEl.textContent = '00:00:00';
                            location.reload();
                            return;
                        }
                        
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        const pad = (n) => n.toString().padStart(2, '0');
                        
                        if (hours >= 24) {
                            const days = Math.floor(hours / 24);
                            const remainingHours = hours % 24;
                            countdownEl.textContent = `${days}d ${pad(remainingHours)}:${pad(minutes)}:${pad(seconds)}`;
                        } else {
                            countdownEl.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
                        }
                    }
                    
                    updateCountdown();
                    setInterval(updateCountdown, 1000);
                })();
            </script>
            <% } %>
        </div>
        
        <!-- Candidates Section -->
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">Candidates (<%= candidates.length %>)</h2>
                <% if (election.status === 'DRAFT') { %>
                    <button type="button" class="btn btn-primary btn-sm" id="addCandidateBtn">
                        <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 0.25rem;"></i>
                        Add Candidate
                    </button>
                <% } %>
            </div>
            
            <% if (candidates.length === 0) { %>
                <div class="empty-state" style="padding: 2rem; text-align: center; background: var(--light-bg); border-radius: 8px;">
                    <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 1rem; color: var(--secondary-color);"></i>
                    <p style="color: var(--secondary-color);">No candidates added yet.</p>
                    <% if (election.status === 'DRAFT') { %>
                        <p style="font-size: 0.875rem; color: var(--secondary-color);">Add at least 2 candidates before activating this election.</p>
                    <% } %>
                </div>
            <% } else { %>
                <div style="background: white; border-radius: 8px; border: 1px solid var(--border); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light-bg);">
                                <th style="padding: 0.75rem 1rem; text-align: left;">Name</th>
                                <th style="padding: 0.75rem 1rem; text-align: left;">Party</th>
                                <th style="padding: 0.75rem 1rem; text-align: left;">Biography</th>
                                <% if (election.status === 'DRAFT') { %>
                                    <th style="padding: 0.75rem 1rem; text-align: center; width: 100px;">Actions</th>
                                <% } %>
                            </tr>
                        </thead>
                        <tbody>
                            <% candidates.forEach(candidate => { %>
                                <tr style="border-top: 1px solid var(--border);">
                                    <td style="padding: 0.75rem 1rem;"><strong><%= candidate.name %></strong></td>
                                    <td style="padding: 0.75rem 1rem;"><%= candidate.party %></td>
                                    <td style="padding: 0.75rem 1rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><%= candidate.biography %></td>
                                    <% if (election.status === 'DRAFT') { %>
                                        <td style="padding: 0.75rem 1rem; text-align: center;">
                                            <form method="POST" action="/admin/elections/<%= election.electionID %>/candidates/<%= candidate.candidateID %>/remove" style="margin: 0; display: inline;">
                                                <button type="submit" class="btn-icon btn-danger-icon" title="Remove candidate" onclick="return confirm('Are you sure you want to remove this candidate?');">
                                                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                                </button>
                                            </form>
                                        </td>
                                    <% } %>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } %>
            
            <% if (election.status === 'DRAFT' && candidates.length >= 2) { %>
                <div class="alert alert-info" style="display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; background: #e0f2fe; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem;">
                    <i data-lucide="info" style="width: 20px; height: 20px; color: #0369a1;"></i>
                    <span style="color: #0369a1;">This election has enough candidates and can be activated.</span>
                </div>
            <% } %>
        </div>
        
        <% if (election.status === 'ACTIVE') { %>
        <div class="admin-section">
            <h2>Admin Actions</h2>
            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);">
                <div class="action-row">
                    <div>
                        <h4>Call Results Early</h4>
                        <p>End this election before the scheduled end date and make results available</p>
                    </div>
                    <form method="POST" action="/admin/elections/<%= election.electionID %>/close" style="margin: 0;">
                        <button 
                            type="submit" 
                            class="btn btn-danger"
                            onclick="return confirm('Are you sure you want to close this election early? This action cannot be undone.');">
                            <i data-lucide="lock" style="width: 16px; height: 16px; margin-right: 4px;"></i> Close Election
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <% } %>
        
        <% if (election.status === 'CLOSED' && results) { %>
        <div class="admin-section">
            <h2>Election Results</h2>
            
            <% if (hasTie && !tieResolution) { %>
            <div class="alert alert-warning" style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
                <i data-lucide="alert-triangle" class="icon-md icon-warning"></i>
                <div>
                    <strong>Tie Detected</strong>
                    <p style="margin: 0.25rem 0 0;">Multiple candidates share the top position. Admin resolution is required to determine the winner.</p>
                </div>
            </div>
            <% } %>
            
            <% if (tieResolution) { %>
            <div class="alert alert-success" style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
                <i data-lucide="check-circle" class="icon-md icon-success"></i>
                <div>
                    <strong>Tie Resolved</strong>
                    <p style="margin: 0.25rem 0 0;">
                        <% if (tieResolution.resolutionType === 'RANDOM') { %>
                            Winner selected by random draw.
                        <% } else if (tieResolution.resolutionType === 'MANUAL') { %>
                            Winner selected manually by administrator.
                        <% } else if (tieResolution.resolutionType === 'RECALL') { %>
                            Election marked for recall ballot.
                        <% } %>
                        <% if (tieResolution.notes) { %>
                            <br><em>Notes: <%= tieResolution.notes %></em>
                        <% } %>
                    </p>
                </div>
            </div>
            <% } %>
            
            <div style="background: white; border-radius: 8px; border: 1px solid var(--border); overflow: hidden;">
                <table class="results-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--light-bg);">
                            <th style="padding: 0.75rem 1rem; text-align: left;">Rank</th>
                            <th style="padding: 0.75rem 1rem; text-align: left;">Candidate</th>
                            <th style="padding: 0.75rem 1rem; text-align: right;">Votes</th>
                            <th style="padding: 0.75rem 1rem; text-align: right;">Percentage</th>
                            <th style="padding: 0.75rem 1rem; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                        const totalVotes = results.reduce((sum, r) => sum + r.votes, 0);
                        results.forEach((result, index) => { 
                            const percentage = totalVotes > 0 ? ((result.votes / totalVotes) * 100).toFixed(1) : '0.0';
                            const isWinner = index === 0 && !result.isTied;
                            const isResolvedWinner = tieResolution && tieResolution.winnerCandidateID === result.candidateID;
                            const showTiedStyle = result.isTied && !tieResolution;
                            const rowClass = isResolvedWinner ? 'winner' : (showTiedStyle ? 'tied' : '');
                        %>
                        <tr class="<%= rowClass %>" style="border-top: 1px solid var(--border);">
                            <td style="padding: 0.75rem 1rem;"><%= index + 1 %></td>
                            <td style="padding: 0.75rem 1rem;"><%= result.candidateName %></td>
                            <td style="padding: 0.75rem 1rem; text-align: right;"><%= result.votes %></td>
                            <td style="padding: 0.75rem 1rem; text-align: right;"><%= percentage %>%</td>
                            <td style="padding: 0.75rem 1rem; text-align: center;">
                                <% if (isResolvedWinner) { %>
                                    <span class="badge badge-success">Winner</span>
                                <% } else if (result.isTied && !tieResolution) { %>
                                    <span class="tied-badge">Tied</span>
                                <% } else if (isWinner) { %>
                                    <span class="badge badge-success">Winner</span>
                                <% } else if (tieResolution && tieResolution.resolutionType === 'RECALL' && result.isTied) { %>
                                    <span class="badge badge-warning">Recall</span>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
        
        <% if (hasTie && !tieResolution) { %>
        <div class="admin-section">
            <h2>Resolve Tie</h2>
            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);">
                <form method="POST" action="/admin/elections/<%= election.electionID %>/resolve-tie" id="tieResolutionForm">
                    <div style="margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 1rem; color: var(--secondary-color);">
                            Choose how to resolve the tie between the following candidates:
                            <strong><%= results.filter(r => r.isTied).map(r => r.candidateName).join(', ') %></strong>
                        </p>
                        
                        <div class="resolution-options" style="display: flex; flex-direction: column; gap: 1rem;">
                            <label class="resolution-option" style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="resolutionType" value="RANDOM" required style="margin-top: 0.25rem;">
                                <div>
                                    <strong style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i data-lucide="shuffle" class="icon-sm"></i>
                                        Random Selection
                                    </strong>
                                    <p style="margin: 0.25rem 0 0; color: var(--secondary-color); font-size: 0.875rem;">
                                        System will randomly select one of the tied candidates as the winner.
                                    </p>
                                </div>
                            </label>
                            
                            <label class="resolution-option" style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="resolutionType" value="MANUAL" required style="margin-top: 0.25rem;">
                                <div style="flex: 1;">
                                    <strong style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i data-lucide="user-check" class="icon-sm"></i>
                                        Manual Selection
                                    </strong>
                                    <p style="margin: 0.25rem 0 0.5rem; color: var(--secondary-color); font-size: 0.875rem;">
                                        Manually select the winner from the tied candidates.
                                    </p>
                                    <select name="selectedCandidate" id="candidateSelect" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;" disabled>
                                        <option value="">Select a candidate...</option>
                                        <% results.filter(r => r.isTied).forEach(result => { %>
                                            <option value="<%= result.candidateID %>"><%= result.candidateName %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </label>
                            
                            <label class="resolution-option" style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="resolutionType" value="RECALL" required style="margin-top: 0.25rem;">
                                <div>
                                    <strong style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i data-lucide="refresh-cw" class="icon-sm"></i>
                                        Recall Ballot
                                    </strong>
                                    <p style="margin: 0.25rem 0 0; color: var(--secondary-color); font-size: 0.875rem;">
                                        Mark this election for a recall ballot. A new election will need to be created.
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes (optional)</label>
                        <textarea name="notes" id="notes" rows="3" placeholder="Add any notes about this resolution decision..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to resolve this tie? This action cannot be undone.');">
                        <i data-lucide="check" class="icon-sm"></i>
                        Confirm Resolution
                    </button>
                </form>
            </div>
        </div>
        
        <script>
            // Enable/disable candidate select based on resolution type
            document.querySelectorAll('input[name="resolutionType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const candidateSelect = document.getElementById('candidateSelect');
                    if (this.value === 'MANUAL') {
                        candidateSelect.disabled = false;
                        candidateSelect.required = true;
                    } else {
                        candidateSelect.disabled = true;
                        candidateSelect.required = false;
                        candidateSelect.value = '';
                    }
                });
            });
        </script>
        <% } %>
        <% } %>
        
        <div class="admin-section">
            <h2>Actions</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="/elections/<%= election.electionID %>" class="btn btn-primary">
                    <i data-lucide="external-link" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
                    View Public Page
                </a>
                <% if (election.status === 'CLOSED') { %>
                    <a href="/elections/<%= election.electionID %>/results" class="btn btn-secondary">
                        <i data-lucide="bar-chart" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
                        View Results
                    </a>
                <% } %>
                <% if (election.status === 'DRAFT') { %>
                    <form method="POST" action="/admin/elections/<%= election.electionID %>/activate" style="margin: 0;">
                        <button type="submit" class="btn btn-success" <%= candidates.length < 2 ? 'disabled' : '' %> onclick="return confirm('Are you sure you want to activate this election? Candidates cannot be modified after activation.');">
                            <i data-lucide="play" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
                            Activate Election
                        </button>
                    </form>
                    <form method="POST" action="/admin/elections/<%= election.electionID %>/delete" style="margin: 0;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this election? This action cannot be undone.');">
                            <i data-lucide="trash-2" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
                            Delete Election
                        </button>
                    </form>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Add Candidate Modal -->
<% if (election.status === 'DRAFT') { %>
<div id="addCandidateModal" class="modal-overlay" hidden>
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border-bottom: 1px solid var(--border);">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="user-plus" style="width: 24px; height: 24px;"></i>
                Add Candidate
            </h2>
            <button type="button" id="closeCandidateModalBtn" class="btn-icon" style="background: none; border: none; cursor: pointer;">
                <i data-lucide="x" style="width: 24px; height: 24px;"></i>
            </button>
        </div>
        <form method="POST" action="/admin/elections/<%= election.electionID %>/candidates" id="addCandidateForm">
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="candidateName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name *</label>
                    <input type="text" id="candidateName" name="name" required class="form-input" placeholder="e.g., John Smith" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="candidateParty" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Party *</label>
                    <input type="text" id="candidateParty" name="party" required class="form-input" placeholder="e.g., Independent" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="candidateBiography" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Biography *</label>
                    <textarea id="candidateBiography" name="biography" required class="form-input" rows="3" placeholder="Brief biography of the candidate..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button type="button" id="cancelCandidateModalBtn" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 0.25rem;"></i>
                    Add Candidate
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Add Candidate Modal
    (function() {
        const modal = document.getElementById('addCandidateModal');
        const openBtn = document.getElementById('addCandidateBtn');
        const closeBtn = document.getElementById('closeCandidateModalBtn');
        const cancelBtn = document.getElementById('cancelCandidateModalBtn');

        if (!modal || !openBtn) return;

        const openModal = () => {
            modal.hidden = false;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const closeModal = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);
        cancelBtn?.addEventListener('click', closeModal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.hidden) closeModal();
        });
    })();
</script>
<% } %>

<%- include('../partials/footer') %>
